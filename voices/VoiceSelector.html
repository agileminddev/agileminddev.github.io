<!DOCTYPE HTML>
<html lang="en">
<head>
  <title>Voice Selector</title>
  <meta content="text/html;charset=utf-8" http-equiv="Content-type"/>
  <link href="../favicon.ico" rel="icon" type="image/x-icon"/>
  <style>
      body {
          font-family: 'Lato', 'Lucida Sans Unicode', Helvetica, Arial, Verdana, sans-serif;
          background-color: #fff;
          color: #000;
          margin-top: 0;
      }

      #buttons {
          height: 2em;
          width: 100vw;
          padding-top: 1em;
          padding-bottom: 1em;
          display: flex;
          flex-direction: row;
      }

      button {
          flex: none;
      }

      button,
      input {
          margin-left: 0.5em;
          margin-right: 0.5em;
      }

      #phrase {
          flex: auto;
          margin-right: 2em;
      }

      #regex {
          display: none;
      }
  </style>
  <script>
      // global speech object
      const synth = window.speechSynthesis;

      // return SpeechSynthesisVoice that matches the given regex array
      function findVoice(list) {
          console.log(list);
          const voices = synth.getVoices();

          if (list) {
              for (const pattern of list.split(';')) {
                  const parts = pattern.split('/');
                  if (parts) {
                      const regex = new RegExp(parts[0].trim(), parts[1].trim() || '');
                      for (const voice of voices) {
                          console.log('%o -- %o', regex, voice);
                          if (voice && voice.lang === 'en-US' && voice.voiceURI.match(regex)) {
                              return voice;
                          }
                      }
                  }
              }
          }

          return null;
      }

      // global to prevent garbage collection
      let utterThis = null;

      // speak what is in the text box using the selected voice, or the button lang if no voice selected
      function speak(button) {
          if (utterThis) {
              // don't queue up phrases; cancel the current one if in progress
              synth.cancel();
          }

          // decide what to say
          const phrase = document.getElementById('phrase').value.trim() || "I don't know what to say";
          utterThis = new SpeechSynthesisUtterance(phrase);

          // choose a voice
          const voice = findVoice(document.getElementById('regex').value);
          document.getElementById('chosen').innerHTML = voice ? `Voice selected: ${voice.name} (${voice.voiceURI})` : 'null';
          if (voice) {
              utterThis.voice = voice;
              // Android requires lang to be set even when voice is specified
              utterThis.lang = voice.lang;
          } else {
              // supplying lang without a voice is supposed to pick an appropriate voice, but only Chrome/Edge seem to behave consistently
              utterThis.lang = 'en-US';
          }

          utterThis.onend = () => {
              // done speaking, so allow object to be GCed
              utterThis = null;
          };

          console.log('Utterance: ', utterThis);
          synth.speak(utterThis);
      }

      synth.onvoiceschanged = () => {
          console.log('available voices changed...');
      }

      function loadScript(url, callback) {
          let script = document.createElement('script');
          script.type = 'text/javascript';
          script.src = url;

          // Then bind the event to the callback function.
          // There are several events for cross browser compatibility.
          script.onreadystatechange = callback;
          script.onload = callback;

          // Fire the loading
          document.head.appendChild(script);
      }

      function init() {
          const url = new URL(window.location);
          if (url.searchParams.get("console") !== null) {
              loadScript('http://cdn.jsdelivr.net/npm/eruda', function() { eruda.init(); });
          }
      }
  </script>
</head>
<body onload="init();">
  <div id="buttons">
    <button onclick="speak(this)">Speak</button>
    <input id="phrase" pattern=".*[A-Za-z0-9].*" placeholder="Phrase to speak" type="text"
           value="The absolute value of 4 minus 7 equals 3"/>
  </div>
  <div id="voice">
    <input id="regex" placeholder="Semicolon separated regex array" type="text"
           value="samantha.*premium/i;Samantha/i;Google US English;Aria.*Natural;Vicki/i;Zira/i;English.*United States" />
    <p id="chosen" />
  </div>
</body>
</html>
